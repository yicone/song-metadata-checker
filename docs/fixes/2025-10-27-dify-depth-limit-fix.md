# Dify Cloud æ·±åº¦é™åˆ¶é”™è¯¯ä¿®å¤

> **æ—¥æœŸ**: 2025-10-27  
> **é”™è¯¯**: `Depth limit 5 reached, object too deep.`  
> **èŠ‚ç‚¹**: `find_qqmusic_match`  
> **åŸå› **: è¿”å›äº†åµŒå¥—å±‚çº§è¿‡æ·±çš„ `debug_data` å­—æ®µ  
> **ä¿®å¤**: ç§»é™¤ `debug_data` å­—æ®µ

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
Depth limit 5 reached, object too deep.
```

### å‘ç”Ÿä½ç½®

**èŠ‚ç‚¹**: `find_qqmusic_match` (æ­¥éª¤ 8)

### é”™è¯¯åŸå› 

åœ¨ `find_qqmusic_match` èŠ‚ç‚¹çš„ä»£ç ä¸­ï¼Œå½“æœç´¢æ— ç»“æœæ—¶ï¼Œè¿”å›äº†å®Œæ•´çš„åŸå§‹æœç´¢æ•°æ®ï¼š

```python
if not results:
    return {
        "match_id": "",
        "match_found": False,
        "error": "æœç´¢æ— ç»“æœ",
        "debug_data": search_data  # âŒ é—®é¢˜æ‰€åœ¨
    }
```

**é—®é¢˜åˆ†æ**:

1. `search_data` æ˜¯ QQ Music API çš„å®Œæ•´å“åº”
2. æ•°æ®ç»“æ„åµŒå¥—å±‚çº§å¾ˆæ·±ï¼š`response.data.song.list[].album.singers[].singer_name`
3. Dify Cloud é™åˆ¶å¯¹è±¡æ·±åº¦æœ€å¤§ä¸º **5 å±‚**
4. è¿”å› `debug_data` å¯¼è‡´è¶…è¿‡æ·±åº¦é™åˆ¶

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**ä¹‹å‰** (æœ‰é—®é¢˜):

```python
if not results:
    return {
        "match_id": "",
        "match_found": False,
        "error": "æœç´¢æ— ç»“æœ",
        "debug_data": search_data  # âŒ å¯¼è‡´æ·±åº¦è¶…é™
    }
```

**ç°åœ¨** (å·²ä¿®å¤):

```python
if not results:
    return {
        "match_id": "",
        "match_found": False,
        "error": "æœç´¢æ— ç»“æœ"
    }
```

### å…³é”®æ”¹åŠ¨

- âŒ ç§»é™¤ `"debug_data": search_data`
- âœ… ä¿ç•™å¿…è¦çš„é”™è¯¯ä¿¡æ¯
- âœ… ä¿æŒè¾“å‡ºç»“æ„ç®€å•

---

## ğŸ“Š Dify Cloud æ·±åº¦é™åˆ¶

### é™åˆ¶è¯´æ˜

**Dify Cloud å¯¹è±¡æ·±åº¦é™åˆ¶**: æœ€å¤§ **5 å±‚**

**ç¤ºä¾‹**:

```python
# âœ… æ·±åº¦ 3 - å…è®¸
{
    "level1": {
        "level2": {
            "level3": "value"
        }
    }
}

# âŒ æ·±åº¦ 6 - è¶…é™
{
    "level1": {
        "level2": {
            "level3": {
                "level4": {
                    "level5": {
                        "level6": "value"  # è¶…è¿‡é™åˆ¶
                    }
                }
            }
        }
    }
}
```

### QQ Music API å“åº”æ·±åº¦

**å®é™…ç»“æ„**:

```json
{
  "response": {           // æ·±åº¦ 1
    "data": {             // æ·±åº¦ 2
      "song": {           // æ·±åº¦ 3
        "list": [         // æ·±åº¦ 4
          {
            "album": {    // æ·±åº¦ 5
              "singers": [// æ·±åº¦ 6 âŒ è¶…é™
                {
                  "singer_name": "..."
                }
              ]
            }
          }
        ]
      }
    }
  }
}
```

**æ·±åº¦**: è‡³å°‘ **6 å±‚**ï¼Œè¶…è¿‡ Dify é™åˆ¶

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é¿å…è¿”å›å®Œæ•´çš„ API å“åº”

**âŒ ä¸æ¨è**:

```python
return {
    "result": api_response,  # å®Œæ•´å“åº”å¯èƒ½å¾ˆæ·±
    "debug_data": raw_data   # è°ƒè¯•æ•°æ®å¯èƒ½å¾ˆæ·±
}
```

**âœ… æ¨è**:

```python
return {
    "match_id": extracted_value,
    "match_name": extracted_value,
    "match_found": True
}
```

### 2. æå–å¿…è¦å­—æ®µ

**âŒ ä¸æ¨è**:

```python
return {
    "match": best_match  # åŒ…å«æ‰€æœ‰åµŒå¥—å­—æ®µ
}
```

**âœ… æ¨è**:

```python
return {
    "match_id": best_match.get('songmid', ''),
    "match_name": best_match.get('songname', ''),
    "match_album": best_match.get('albumname', '')
}
```

### 3. å¹³é“ºè¾“å‡ºç»“æ„

**âŒ ä¸æ¨è**:

```python
return {
    "result": {
        "match": {
            "song": {
                "id": "...",
                "name": "..."
            }
        }
    }
}
```

**âœ… æ¨è**:

```python
return {
    "match_id": "...",
    "match_name": "...",
    "match_found": True
}
```

### 4. è°ƒè¯•ä¿¡æ¯å¤„ç†

å¦‚æœéœ€è¦è°ƒè¯•ä¿¡æ¯ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

**æ–¹æ³• 1**: ä½¿ç”¨ `print()` è¾“å‡ºåˆ°æ—¥å¿—

```python
print(f"è°ƒè¯•ä¿¡æ¯: {json.dumps(search_data, ensure_ascii=False, indent=2)}")
```

**æ–¹æ³• 2**: è¿”å›ç®€åŒ–çš„è°ƒè¯•ä¿¡æ¯

```python
return {
    "match_found": False,
    "error": "æœç´¢æ— ç»“æœ",
    "debug_info": f"ç»“æœæ•°é‡: {len(results)}"  # ç®€å•å­—ç¬¦ä¸²
}
```

**æ–¹æ³• 3**: è¿”å›å…³é”®å­—æ®µçš„æ‘˜è¦

```python
return {
    "match_found": False,
    "error": "æœç´¢æ— ç»“æœ",
    "response_keys": list(search_data.keys()),  # åªè¿”å›é”®å
    "results_count": len(results)
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•æ— ç»“æœåœºæ™¯

**è¾“å…¥**: ä¸å­˜åœ¨çš„æ­Œæ›²

**é¢„æœŸè¾“å‡º**:

```json
{
  "match_id": "",
  "match_found": false,
  "error": "æœç´¢æ— ç»“æœ"
}
```

**éªŒè¯**:

- âœ… ä¸æŠ¥ "Depth limit" é”™è¯¯
- âœ… è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… å·¥ä½œæµå¯ä»¥ç»§ç»­æ‰§è¡Œ

### 2. æµ‹è¯•æœ‰ç»“æœåœºæ™¯

**è¾“å…¥**: å­˜åœ¨çš„æ­Œæ›²

**é¢„æœŸè¾“å‡º**:

```json
{
  "match_id": "001abc123",
  "match_name": "ç¤ºä¾‹æ­Œæ›²",
  "match_album": "ç¤ºä¾‹ä¸“è¾‘",
  "match_found": true
}
```

**éªŒè¯**:

- âœ… æ­£ç¡®æå–æ­Œæ›²ä¿¡æ¯
- âœ… è¾“å‡ºç»“æ„ç®€å•
- âœ… æ·±åº¦ä¸è¶…è¿‡ 3 å±‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DIFY_CLOUD_MANUAL_SETUP.md](../guides/DIFY_CLOUD_MANUAL_SETUP.md#æ­¥éª¤-8-æ·»åŠ ä»£ç èŠ‚ç‚¹---æ‰¾åˆ°-qq-éŸ³ä¹åŒ¹é…) - æ›´æ–°åçš„èŠ‚ç‚¹é…ç½®
- [Dify Cloud é™åˆ¶è¯´æ˜](https://docs.dify.ai/guides/workflow/node/code#limitations) - å®˜æ–¹æ–‡æ¡£

---

## ğŸ” å…¶ä»–å¯èƒ½çš„æ·±åº¦é™åˆ¶é—®é¢˜

### æ£€æŸ¥æ¸…å•

æ£€æŸ¥ä»¥ä¸‹èŠ‚ç‚¹æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜ï¼š

- [ ] `initial_data_structuring` - æ˜¯å¦è¿”å›äº†å®Œæ•´çš„ API å“åº”ï¼Ÿ
- [ ] `parse_qqmusic_response` - æ˜¯å¦è¿”å›äº†åµŒå¥—çš„åŸå§‹æ•°æ®ï¼Ÿ
- [ ] `parse_gemini_response` - æ˜¯å¦è¿”å›äº†å®Œæ•´çš„ Gemini å“åº”ï¼Ÿ
- [ ] `consolidate` - æ˜¯å¦åœ¨ `raw_values` ä¸­åŒ…å«äº†æ·±å±‚åµŒå¥—å¯¹è±¡ï¼Ÿ

### é€šç”¨ä¿®å¤æ–¹æ³•

1. **æ£€æŸ¥æ‰€æœ‰è¿”å›å€¼**:
   - ç¡®ä¿æ·±åº¦ä¸è¶…è¿‡ 5 å±‚
   - ä¼˜å…ˆä½¿ç”¨å¹³é“ºç»“æ„

2. **ç§»é™¤è°ƒè¯•å­—æ®µ**:
   - `debug_data`
   - `raw_response`
   - `full_result`

3. **æå–å¿…è¦å­—æ®µ**:
   - åªè¿”å›å·¥ä½œæµéœ€è¦çš„å­—æ®µ
   - é¿å…è¿”å›å®Œæ•´çš„å¯¹è±¡

4. **ä½¿ç”¨ print() è°ƒè¯•**:
   - è°ƒè¯•ä¿¡æ¯è¾“å‡ºåˆ°æ—¥å¿—
   - ä¸è¦è¿”å›åˆ°è¾“å‡ºå˜é‡

---

## âœ… ä¿®å¤æ£€æŸ¥æ¸…å•

- [x] è¯†åˆ«é—®é¢˜ï¼š`debug_data` å¯¼è‡´æ·±åº¦è¶…é™
- [x] ç§»é™¤ `debug_data` å­—æ®µ
- [x] æ›´æ–°æ–‡æ¡£
- [x] æµ‹è¯•æ— ç»“æœåœºæ™¯
- [x] æµ‹è¯•æœ‰ç»“æœåœºæ™¯
- [x] éªŒè¯ä¸å†æŠ¥æ·±åº¦é™åˆ¶é”™è¯¯

---

## ğŸ¯ å…³é”®è¦ç‚¹

### Dify Cloud é™åˆ¶

- **æœ€å¤§æ·±åº¦**: 5 å±‚
- **å½±å“**: è¿”å›æ·±å±‚åµŒå¥—å¯¹è±¡ä¼šå¯¼è‡´é”™è¯¯
- **è§£å†³**: å¹³é“ºè¾“å‡ºç»“æ„ï¼Œåªè¿”å›å¿…è¦å­—æ®µ

### æœ€ä½³å®è·µ

1. âœ… æå–å¿…è¦å­—æ®µï¼Œä¸è¿”å›å®Œæ•´å¯¹è±¡
2. âœ… ä½¿ç”¨å¹³é“ºç»“æ„ï¼Œé¿å…æ·±å±‚åµŒå¥—
3. âœ… è°ƒè¯•ä¿¡æ¯ä½¿ç”¨ `print()`ï¼Œä¸è¿”å›åˆ°è¾“å‡º
4. âœ… ä¿æŒè¾“å‡ºç»“æ„ç®€å•æ¸…æ™°

---

**ä¿®å¤æ—¶é—´**: 2025-10-27  
**ç»´æŠ¤è€…**: [documentation-agent]  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•
